{
  "sha": "9b4b4ce9d857c07128199d50bb729dc7e3a6621e",
  "url": "https://github.com/MicrosoftDocs/entra-docs/commit/9b4b4ce9d857c07128199d50bb729dc7e3a6621e",
  "author": "learn-build-service-prod[bot]",
  "email": "113403604+learn-build-service-prod[bot]@users.noreply.github.com",
  "date": "2025-09-18T22:02:55Z",
  "message": "Merge pull request #9733 from MicrosoftDocs/main\n\nAuto Publish – main to live - 2025-09-18 22:00 UTC",
  "ai_summary": {
    "Messages": "{\"role\":\"user\",\"content\":\"The following is the commit files that have changed: [\\r\\n  {\\r\\n    \\\"sha\\\": \\\"9414c537b589f9494f78b3866e5071426ffb90a7\\\",\\r\\n    \\\"filename\\\": \\\"docs/identity/hybrid/connect/how-to-connect-emergency-ad-fs-certificate-rotation.md\\\",\\r\\n    \\\"status\\\": \\\"modified\\\",\\r\\n    \\\"additions\\\": 27,\\r\\n    \\\"deletions\\\": 20,\\r\\n    \\\"changes\\\": 47,\\r\\n    \\\"blob_url\\\": \\\"https://github.com/MicrosoftDocs/entra-docs/blob/9b4b4ce9d857c07128199d50bb729dc7e3a6621e/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-emergency-ad-fs-certificate-rotation.md\\\",\\r\\n    \\\"raw_url\\\": \\\"https://github.com/MicrosoftDocs/entra-docs/raw/9b4b4ce9d857c07128199d50bb729dc7e3a6621e/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-emergency-ad-fs-certificate-rotation.md\\\",\\r\\n    \\\"contents_url\\\": \\\"https://api.github.com/repos/MicrosoftDocs/entra-docs/contents/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-emergency-ad-fs-certificate-rotation.md?ref=9b4b4ce9d857c07128199d50bb729dc7e3a6621e\\\",\\r\\n    \\\"patch\\\": \\\"@@ -6,7 +6,7 @@ manager: mwongerapk\\\\n ms.service: entra-id\\\\n ms.custom: no-azure-ad-ps-ref\\\\n ms.topic: how-to\\\\n-ms.date: 04/09/2025\\\\n+ms.date: 09/18/2025\\\\n ms.subservice: hybrid-connect\\\\n ms.author: jomondi\\\\n ---\\\\n@@ -24,12 +24,19 @@ If you need to rotate the Active Directory Federation Services (AD FS) certifica\\\\n \\\\n ## Determine your Token Signing Certificate thumbprint\\\\n \\\\n-To revoke the old Token Signing Certificate that AD FS is currently using, you need to determine the thumbprint of the token-signing certificate. Do the following:\\\\n+To revoke the old Token Signing Certificate that AD FS is currently using, you need to determine the thumbprint of the token-signing certificate. From your ADFS Server do the following:\\\\n \\\\n-1. Connect to the Microsoft Online Service by running in PowerShell `Connect-MsolService`.\\\\n+1. Connect to the Microsoft Entra PowerShell module:\\\\n \\\\n-1. Document both your on-premises and cloud Token Signing Certificate thumbprint and expiration dates by running `Get-MsolFederationProperty -DomainName <domain>`.\\\\n-1. Copy down the thumbprint. You'll use it later to remove the existing certificates.\\\\n+   `Connect-Entra -Scopes 'Domain.Read.All'`.\\\\n+\\\\n+1. Document both your on-premises and cloud Token Signing Certificate thumbprint and expiration dates by running:\\\\n+  \\\\n+   - `Get-AdfsCertificate -CertificateType token-signing`\\\\n+\\\\n+   - `Get-EntraFederationProperty -DomainName <your_domain.com> | FL Source, SigningCertificate`.\\\\n+  \\\\n+1. Copy the thumbprint. You'll use it later to remove the existing certificates.\\\\n \\\\n You can also get the thumbprint by using AD FS Management. Go to **Service** > **Certificates**, right-click the certificate, select **View certificate**, and then select **Details**.\\\\n \\\\n@@ -123,28 +130,28 @@ Now that you've added the first certificate, made it primary, and removed the ol\\\\n \\\\n ## Update Microsoft Entra ID with the new token-signing certificate\\\\n \\\\n-1. Open the Azure AD PowerShell module. Alternatively, open Windows PowerShell, and then run the `Import-Module msonline` command.\\\\n-\\\\n 1. Connect to Microsoft Entra ID by running the following command: \\\\n \\\\n-   `Connect-MsolService`\\\\n+   `Connect-Entra -Scopes 'Domain.Read.All'`\\\\n    \\\\n 1. Enter your [Hybrid Identity Administrator](/entra/identity/role-based-access-control/permissions-reference#hybrid-identity-administrator) credentials.\\\\n \\\\n-    > [!Note]\\\\n-    > If you're running these commands on a computer that isn't the primary federation server, enter the following command first: \\\\n-    >\\\\n-    >   `Set-MsolADFSContext -Computer <servername>`\\\\n-    >\\\\n-    > Replace \\\\\\\\<servername\\\\\\\\> with the name of the AD FS server and then, at the prompt, enter the administrator credentials for the AD FS server.\\\\n+1. Optionally, verify whether an update is required by checking the current certificate information in Microsoft Entra ID. To do so, run the following command:\\\\n+  \\\\n+   `Get-EntraFederationProperty -DomainName <your_domain.com> | FL Source, SigningCertificate` and convert the Base64 Encoded cert to a readable format to check the certificate expiration and thumbprint. \\\\n+\\\\n+1. To update the certificate information in Microsoft Entra ID, run the following command: `Update-MgDomainFederationConfiguration -DomainId <your_domain.com> -InternalDomainFederationId <hex_domainID>`.\\\\n+\\\\n+   >[!IMPORTANT]\\\\n+\\\\n+   You can get the **-InternalDomainFederationId** value by running the following command:\\\\n \\\\n-1. Optionally, verify whether an update is required by checking the current certificate information in Microsoft Entra ID. To do so, run the following command: `Get-MsolFederationProperty`. Enter the name of the Federated domain when prompted.\\\\n+   `Get-EntraFederationProperty -DomainName your_domain.com`\\\\n \\\\n-1. To update the certificate information in Microsoft Entra ID, run the following command: `Update-MsolFederatedDomain` and then enter the domain name when prompted.\\\\n+    :::image type=\\\\\\\"content\\\\\\\" source=\\\\\\\"./media/how-to-connect-install-multiple-domains/entra-fed-property.png\\\\\\\" alt-text=\\\\\\\"Screenshot shows output of the Get-EntraFederationProperty cmdlet.\\\\\\\":::\\\\n \\\\n-    > [!Note]\\\\n-    > If you receive an error when you run this command, run `Update-MsolFederatedDomain -SupportMultipleDomain` and then, at the prompt, enter the domain name.\\\\n \\\\n+  \\\\n ## Replace SSL certificates\\\\n \\\\n If you need to replace your token-signing certificate because of a compromise, you should also revoke and replace the Secure Sockets Layer (SSL) certificates for AD FS and your Web Application Proxy (WAP) servers.\\\\n@@ -169,10 +176,10 @@ If you've renewed and configure a new token signing or token decryption certific\\\\n If your federation partners can't consume your federation metadata, you must manually send them the public key of your new token-signing / token-decrypting certificate. Send your new certificate public key (.cer file or .p7b if you want to include the entire chain) to all your resource organization or account organization partners (represented in your AD FS by relying party trusts and claims provider trusts). Have the partners implement changes on their side to trust the new certificates.\\\\n \\\\n ## Revoke the refresh tokens via PowerShell\\\\n-Now you want to revoke the refresh tokens for users who might have them and force them to log in again and get new tokens. This logs users out of their phones, current webmail sessions, and other places that are using tokens and refresh tokens. For more information, see [Revoke-EntraUserAllRefreshToken](/powershell/module/microsoft.entra/revoke-entrauserallrefreshtoken). Also see [Revoke user access in Microsoft Entra ID](../../users/users-revoke-access.md).\\\\n+Now you want to revoke the refresh tokens for users who might have them and force them to log in again and get new tokens. This logs users out of their phones, current webmail sessions, and other places that are using tokens and refresh tokens. For more information, see [Revoke-EntraUserAllRefreshToken](/powershell/module/microsoft.entra.authentication/revoke-entrauserallrefreshtoken). Also see [Revoke user access in Microsoft Entra ID](../../users/users-revoke-access.md).\\\\n \\\\n ## Next steps\\\\n \\\\n - [Manage SSL certificates in AD FS and WAP in Windows Server 2016](/windows-server/identity/ad-fs/operations/manage-ssl-certificates-ad-fs-wap#replacing-the-ssl-certificate-for-ad-fs)\\\\n - [Obtain and configure token signing and token decryption certificates for AD FS](/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn781426(v=ws.11)#updating-federation-partners)\\\\n-- [Renew federation certificates for Microsoft 365 and Microsoft Entra ID](how-to-connect-fed-o365-certs.md)\\\\n+- [Renew federation certificates for Microsoft 365 and Microsoft Entra ID](how-to-connect-fed-o365-certs.md)\\\\n\\\\\\\\ No newline at end of file\\\"\\r\\n  },\\r\\n  {\\r\\n    \\\"sha\\\": \\\"61710c9a6a9fe734332192aa9e5831d08d4d7373\\\",\\r\\n    \\\"filename\\\": \\\"docs/identity/hybrid/connect/how-to-connect-fed-o365-certs.md\\\",\\r\\n    \\\"status\\\": \\\"modified\\\",\\r\\n    \\\"additions\\\": 24,\\r\\n    \\\"deletions\\\": 11,\\r\\n    \\\"changes\\\": 35,\\r\\n    \\\"blob_url\\\": \\\"https://github.com/MicrosoftDocs/entra-docs/blob/9b4b4ce9d857c07128199d50bb729dc7e3a6621e/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-fed-o365-certs.md\\\",\\r\\n    \\\"raw_url\\\": \\\"https://github.com/MicrosoftDocs/entra-docs/raw/9b4b4ce9d857c07128199d50bb729dc7e3a6621e/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-fed-o365-certs.md\\\",\\r\\n    \\\"contents_url\\\": \\\"https://api.github.com/repos/MicrosoftDocs/entra-docs/contents/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-fed-o365-certs.md?ref=9b4b4ce9d857c07128199d50bb729dc7e3a6621e\\\",\\r\\n    \\\"patch\\\": \\\"@@ -8,7 +8,7 @@ ms.service: entra-id\\\\n ms.tgt_pltfrm: na\\\\n ms.custom: no-azure-ad-ps-ref, sfi-image-nochange\\\\n ms.topic: how-to\\\\n-ms.date: 04/09/2025\\\\n+ms.date: 09/18/2025\\\\n ms.subservice: hybrid-connect\\\\n ms.author: jomondi\\\\n ---\\\\n@@ -19,7 +19,7 @@ For successful federation between Microsoft Entra ID and Active Directory Federa\\\\n > [!NOTE]\\\\n > This article provides information on managing your federation certificates. For information on emergency rotation see [Emergency Rotation of the AD FS certificates](how-to-connect-emergency-ad-fs-certificate-rotation.md)\\\\n \\\\n-This article provides you additional information to manage your token signing certificates and keep them in sync with Microsoft Entra ID, in the following cases:\\\\n+This article provides you with additional information to manage your token signing certificates and keep them in sync with Microsoft Entra ID, in the following cases:\\\\n \\\\n * You aren't deploying the Web Application Proxy, and therefore the federation metadata is not available in the extranet.\\\\n * You aren't using the default configuration of AD FS for token signing certificates.\\\\n@@ -88,7 +88,7 @@ Connect-Entra -Scopes 'Domain.Read.All'\\\\n Check the certificates configured in AD FS and Microsoft Entra ID trust properties for the specified domain.\\\\n \\\\n ```azurepowershell-interactive\\\\n-Get-EntraFederationProperty -DomainName <domain.name> | FL Source, TokenSigningCertificate\\\\n+Get-EntraFederationProperty -DomainName <domain.name> | FL Source, SigningCertificate\\\\n ```\\\\n If the thumbprints in both the outputs match, your certificates are in sync with Microsoft Entra ID.\\\\n \\\\n@@ -160,18 +160,31 @@ On the other hand, if **AutoCertificateRollover** is set to **True**, but your f\\\\n Two certificates should be listed now, one of which has a **NotAfter** date of approximately one year in the future, and for which the **IsPrimary** value is **False**.\\\\n \\\\n ### Step 2: Update the new token signing certificates for the Microsoft 365 trust\\\\n+\\\\n Update Microsoft 365 with the new token signing certificates to be used for the trust, as follows.\\\\n \\\\n 1. Open Azure PowerShell.\\\\n-1. Run `Connect-Entra -Scopes 'Domain.Read.All'`. This cmdlet connects you to the cloud service. Creating a context that connects you to the cloud service is required before running any of the additional cmdlets installed by the tool.\\\\n-1. Run `Update-MgDomainFederationConfiguration -DomainId <domain> -InternalDomainFederationId <AD FS primary server>`. This cmdlet updates the settings from AD FS into the cloud service, and configures the trust relationship between the two.\\\\n+2. Run `Connect-Entra -Scopes 'Domain.Read.All'`. This cmdlet connects you to the cloud service. Creating a context that connects you to the cloud service is required before running any of the additional cmdlets installed by the tool.\\\\n+  \\\\n+    > [!NOTE]\\\\n+    > `-InternalDomainFederationId` can be found by running the command `Get-EntraFederationProperty -Domainname your_domain.com`\\\\n \\\\n-> [!NOTE]\\\\n-> If you need to support multiple top-level domains, such as contoso.com and fabrikam.com, you must use the **SupportMultipleDomain** switch with any cmdlets. For more information, see [Support for Multiple Top Level Domains](how-to-connect-install-multiple-domains.md).\\\\n->\\\\n-> If your tenant is federated with more than one domain, the `Update-MgDomainFederationConfiguration` needs to be run for all the domains, listed in the output from `Get-EntraDomain | Select-Object -Property AuthenticationType:Federated`. This ensures that all of the federated domains are updated to the Token-Signing certificate.\\\\n->You can achieve this by running:\\\\n->`Get-EntraDomain | Select-Object -Property AuthenticationType:Federated | % { Update-MgDomainFederationConfiguration -DomainName $_.Name -SupportMultipleDomain }`\\\\n+    :::image type=\\\\\\\"content\\\\\\\" source=\\\\\\\"./media/how-to-connect-install-multiple-domains/entra-fed-property.png\\\\\\\" alt-text=\\\\\\\"Screenshot shows output of the Get-EntraFederationProperty cmdlet.\\\\\\\":::\\\\n+\\\\n+3. Run `Update-MgDomainFederationConfiguration -DomainId <your_domain.com> -InternalDomainFederationId <hex_domain ID>`. This cmdlet updates the settings from AD FS into the cloud service, and configures the trust relationship between the two.\\\\n+\\\\n+    > [!NOTE]\\\\n+    > If you need to support multiple top-level domains, such as contoso.com and fabrikam.com, you must apply the above settings and go domain by domain without the **-SupportMultipleDomain** switch since it's no longer available for **Microsoft.Entra** and **Microsoft.Graph** modules.\\\\n+\\\\n+For more information, see [Support for Multiple Top Level Domains](how-to-connect-install-multiple-domains.md).\\\\n+\\\\n+If your tenant is federated with more than one domain, the `Update-MgDomainFederationConfiguration` needs to be run for all the domains, listed in the output from:\\\\n+\\\\n+`Get-EntraDomain | Where-Object {$ _. 'AuthenticationType' -eq 'Federated'} | Select-object Name, AuthenticationType`.\\\\n+\\\\n+This ensures that all of the federated domains are updated to the Token-Signing certificate and you can achieve this by running:\\\\n+\\\\n+`Update-MgDomainFederationConfiguration -DomainId <your_domain.com> -InternalDomainFederationId <hex_domain ID>`\\\\n \\\\n <a name='repair-azure-ad-trust-by-using-azure-ad-connect-a-nameconnectrenewa'></a>\\\\n \\\"\\r\\n  },\\r\\n  {\\r\\n    \\\"sha\\\": \\\"88d29e80d7785d91eb3e9d762532c053239bf236\\\",\\r\\n    \\\"filename\\\": \\\"docs/identity/hybrid/connect/how-to-connect-install-multiple-domains.md\\\",\\r\\n    \\\"status\\\": \\\"modified\\\",\\r\\n    \\\"additions\\\": 65,\\r\\n    \\\"deletions\\\": 69,\\r\\n    \\\"changes\\\": 134,\\r\\n    \\\"blob_url\\\": \\\"https://github.com/MicrosoftDocs/entra-docs/blob/9b4b4ce9d857c07128199d50bb729dc7e3a6621e/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-install-multiple-domains.md\\\",\\r\\n    \\\"raw_url\\\": \\\"https://github.com/MicrosoftDocs/entra-docs/raw/9b4b4ce9d857c07128199d50bb729dc7e3a6621e/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-install-multiple-domains.md\\\",\\r\\n    \\\"contents_url\\\": \\\"https://api.github.com/repos/MicrosoftDocs/entra-docs/contents/docs%2Fidentity%2Fhybrid%2Fconnect%2Fhow-to-connect-install-multiple-domains.md?ref=9b4b4ce9d857c07128199d50bb729dc7e3a6621e\\\",\\r\\n    \\\"patch\\\": \\\"@@ -1,5 +1,5 @@\\\\n ---\\\\n-title: Microsoft Entra Connect Multiple Domains\\\\n+title: Multiple Domain Support for Federating with Microsoft Entra ID\\\\n description: This document describes setting up and configuring multiple top level domains with Microsoft 365 and Microsoft Entra ID.\\\\n author: omondiatieno\\\\n manager: mwongerapk\\\\n@@ -8,124 +8,120 @@ ms.service: entra-id\\\\n ms.tgt_pltfrm: na\\\\n ms.custom: no-azure-ad-ps-ref, sfi-image-nochange\\\\n ms.topic: how-to\\\\n-ms.date: 04/09/2025\\\\n+ms.date: 09/18/2025\\\\n ms.subservice: hybrid-connect\\\\n ms.author: jomondi\\\\n ---\\\\n # Multiple Domain Support for Federating with Microsoft Entra ID\\\\n-The following documentation provides guidance on how to use multiple top-level domains and subdomains when federating with Microsoft 365 or Microsoft Entra domains.\\\\n+\\\\n+This article provides guidance on using multiple top-level domains and subdomains when federating with Microsoft 365 or Microsoft Entra domains.\\\\n \\\\n ## Multiple top-level domain support\\\\n Federating multiple, top-level domains with Microsoft Entra ID requires some extra configuration that isn't required when federating with one top-level domain.\\\\n \\\\n-When a domain is federated with Microsoft Entra ID, several properties are set on the domain in Azure. One important one is IssuerUri. This property is a URI that is used by Microsoft Entra ID to identify the domain that the token is associated with. The URI doesn’t need to resolve to anything but it must be a valid URI. By default, Microsoft Entra ID sets the URI to the value of the federation service identifier in your on-premises AD FS configuration.\\\\n+When a domain is federated with Microsoft Entra ID, several properties are set on the domain in Azure. One important property is IssuerUri. This property is a URI that is used by Microsoft Entra ID to identify the domain that the token is associated with. The URI doesn’t need to resolve to anything, but it must be a valid URI. By default, Microsoft Entra ID sets the URI to the value of the federation service identifier in your on-premises AD FS configuration.\\\\n \\\\n > [!NOTE]\\\\n-> The federation service identifier is a URI that uniquely identifies a federation service. The federation service is an instance of AD FS that functions as the security token service.\\\\n->\\\\n->\\\\n+> The federation service identifier is a URI that uniquely identifies a federation service. The federation service is an instance of AD FS that acts as the security token service.\\\\n \\\\n You can view the IssuerUri by using the PowerShell command `Get-EntraDomainFederationSettings -DomainName <your domain>`.\\\\n \\\\n-A problem arises when you add more than one top-level domain. For example, let's say you have set up federation between Microsoft Entra ID and your on-premises environment. For this document, the domain, bmcontoso.com is being used. Now a second, top-level domain, bmfabrikam.com has been added.\\\\n+A problem occurs when you add more than one top-level domain. For example, let's say you have set up federation between Microsoft Entra ID and your on-premises environment. For this document, the domain bmcontoso.com is used. Now a second, top-level domain, bmfabrikam.com has been added.\\\\n \\\\n-![A screenshot showing multiple top-level domains](./media/how-to-connect-install-multiple-domains/domains.png)\\\\n+:::image type=\\\\\\\"content\\\\\\\" source=\\\\\\\"./media/how-to-connect-install-multiple-domains/domains.png\\\\\\\" alt-text=\\\\\\\"Screenshot of multiple top-level domains.\\\\\\\":::\\\\n \\\\n-When you attempt to convert the bmfabrikam.com domain to be federated, an error occurs. The reason is, Microsoft Entra ID has a constraint that doesn't allow the IssuerUri property to have the same value for more than one domain. \\\\n+When you attempt to federate the bmfabrikam.com domain, an error occurs. This occurs because Microsoft Entra ID doesn’t allow the IssuerUri property to have the same value for more than one domain. \\\\n \\\\n ### SupportMultipleDomain Parameter\\\\n-To work around this constraint, you need to add a different IssuerUri, which can be done by using the `-SupportMultipleDomain` parameter. This parameter is used with the following cmdlets:\\\\n \\\\n-* `New-MgDomainFederationConfiguration`\\\\n-* `Update-MgDomainFederationConfiguration`\\\\n+> [!NOTE]\\\\n+> SupportMultipleDomain parameter is no longer available and does not work with the following modules:\\\\n+> * `Microsoft.Graph`\\\\n+> * `Microsoft.Entra`\\\\n \\\\n-This parameter makes Microsoft Entra ID configure the IssuerUri so that it's based on the name of the domain. The IssuerUri will be unique across directories in Microsoft Entra ID. Using the parameter allows the PowerShell command to complete successfully.\\\\n+> [!IMPORTANT]\\\\n+> To federate multiple domains, you might need to make changes one by one because the -SupportMultipleDomain parameter is no longer available.\\\\n \\\\n-`-SupportMultipleDomain` doesn't change the other endpoints, which are still configured to point to the federation service on adfs.bmcontoso.com.\\\\n+<a name='how-to-update-the-trust-between-ad-fs-and-azure-ad'></a>\\\\n \\\\n-`-SupportMultipleDomain` also ensures that the AD FS system includes the proper Issuer value in tokens issued for Microsoft Entra ID. This value is set by taking the domain portion of the user's UPN and using it as the domain in the IssuerUri, that is, `https://{upn suffix}/adfs/services/trust`.\\\\n+## How to update the trust between AD FS and Microsoft Entra ID\\\\n \\\\n-Thus during authentication to Microsoft Entra ID or Microsoft 365, the IssuerUri element in the user’s token is used to locate the domain in Microsoft Entra ID. If a match can't be found, the authentication fails.\\\\n+If you've added a new domain in the [Microsoft Entra admin center](https://entra.microsoft.com) and changed the token signing certificate, you're one step away from updating your federation information in Entra ID. \\\\n \\\\n-For example, if a user’s UPN is bsimon@bmcontoso.com, the IssuerUri element in the token, AD FS issuer, is set to `http://bmcontoso.com/adfs/services/trust`. This element matches the Microsoft Entra configuration, and authentication succeeds.\\\\n+Follow these steps to update your federation information in Entra ID:\\\\n \\\\n-The following customized claim rule implements this logic:\\\\n+1. Open a new PowerShell session and run the below commands to install the Microsoft Entra PowerShell module:\\\\n \\\\n-```\\\\n-c:[Type == \\\\\\\"http://schemas.xmlsoap.org/claims/UPN\\\\\\\"] => issue(Type = \\\\\\\"http://schemas.microsoft.com/ws/2008/06/identity/claims/issuerid\\\\\\\", Value = regexreplace(c.Value, \\\\\\\".+@(?<domain>.+)\\\\\\\", \\\\\\\"http://${domain}/adfs/services/trust/\\\\\\\"));\\\\n-```\\\\n+   > [!NOTE] \\\\n+   > `-allowclobber` will override warning messages about installation conflicts and overwrite existing commands that have the same name as commands being installed by a module. Use this value if you already have installed Microsoft.Graph module:\\\\n+  \\\\n+1. * `Install-Module -Name Microsoft.Entra -allowClobber`\\\\n+   * `Import-Module -Name Microsoft.Entra.DirectoryManagement`\\\\n+   * `Connect-Entra -Scopes 'Domain.Read.All'`\\\\n+   * `Get-EntraFederationProperty -domainname domain.com`\\\\n \\\\n+    :::image type=\\\\\\\"content\\\\\\\" source=\\\\\\\"./media/how-to-connect-install-multiple-domains/entra-fed-property.png\\\\\\\" alt-text=\\\\\\\"Screenshot of output of the Get-EntraFederationProperty cmdlet.\\\\\\\":::\\\\n \\\\n-> [!IMPORTANT]\\\\n-> In order to use the -SupportMultipleDomain switch when attempting to add new or convert already existing domains, your federated trust needs to have already been set up to support them.\\\\n->\\\\n->\\\\n \\\\n-<a name='how-to-update-the-trust-between-ad-fs-and-azure-ad'></a>\\\\n+Once you have copied the ID displayed in the second column from the output, run:\\\\n+* `Update-MgDomainFederationConfiguration -DomainID domain.com -InternalDomainFederationId 0f6ftrte-xxxx-xxxx-xxxx-19xxxxxxxx23'`\\\\n \\\\n-## How to update the trust between AD FS and Microsoft Entra ID\\\\n-If you didn't set up the federated trust between AD FS and your instance of Microsoft Entra ID, you may need to re-create this trust. The reason is, when it's originally set up without the `-SupportMultipleDomain` parameter, the IssuerUri is set with the default value. In the screenshot below, you can see the IssuerUri is set to `https://adfs.bmcontoso.com/adfs/services/trust`.\\\\n+Follow these steps to add the new top-level domain using PowerShell:\\\\n \\\\n-If you have successfully added a new domain in the [Microsoft Entra admin center](https://entra.microsoft.com) and then attempt to convert it using `New-MgDomainFederationConfiguration -DomainName <your domain>`, you'll get an error.\\\\n+1. On a machine that has [Azure AD PowerShell module](/previous-versions/azure/jj151815(v=azure.100)) installed on it run the following PowerShell: `$cred=Get-Credential`.\\\\n+1. Enter the username and password of a hybrid identity administrator for the Microsoft Entra domain you're federating with.\\\\n+1. In PowerShell, enter `Connect-Entra -Scopes 'Domain.ReadWrite.All'`\\\\n+1. Enter all the values as the below example to add a new domain:\\\\n \\\\n-Use the steps below to add an additional top-level domain. If you have already added a domain, and didn't use the `-SupportMultipleDomain` parameter, start with the steps for removing and updating your original domain. If you haven't added a top-level domain yet, you can start with the steps for adding a domain using PowerShell of Microsoft Entra Connect.\\\\n+  ```powershell\\\\n+    New-MgDomainFederationConfiguration -DomainId \\\\\\\"contoso.com\\\\\\\" -ActiveSigninUri \\\\\\\" https://sts.contoso.com/adfs/services/trust/2005/usernamemixed\\\\\\\" -DisplayName \\\\\\\"Contoso\\\\\\\" -IssuerUri \\\\\\\" http://contoso.com/adfs/services/trust\\\\\\\" -MetadataExchangeUri \\\\\\\" https://sts.contoso.com/adfs/services/trust/mex\\\\\\\" -PassiveSigninUri \\\\\\\" https://sts.contoso.com/adfs/ls/\\\\\\\" -SignOutUri \\\\\\\" https://sts.contoso.com/adfs/ls/\\\\\\\" -SigningCertificate <*Base64 Encoded Format cert*> -FederatedIdpMfaBehavior \\\\\\\"acceptIfMfaDoneByFederatedIdp\\\\\\\" -PreferredAuthenticationProtocol \\\\\\\"wsFed\\\\\\\"\\\\n+  ```\\\\n \\\\n-Use the following steps to remove the Microsoft Online trust and update your original domain.\\\\n+Follow these steps to add the new top-level domain using Microsoft Entra Connect:\\\\n \\\\n-1. On your AD FS federation server, open **AD FS Management**.\\\\n-1. On the left, expand **Trust Relationships** and **Relying Party Trusts**.\\\\n-1. On the right, delete the **Microsoft Office 365 Identity Platform** entry.\\\\n-  ![Remove Microsoft Online](./media/how-to-connect-install-multiple-domains/trust4.png)\\\\n-1. In PowerShell, enter `Connect-Entra -Scopes 'Domain.ReadWrite.All'`.\\\\n-1. In PowerShell, enter `Update-MgDomainFederationConfiguration -DomainName <Federated Domain Name> -SupportMultipleDomain`. This update is for the original domain. So using the above domains it would be: `Update-MgDomainFederationConfiguration -DomainName bmcontoso.com -SupportMultipleDomain`\\\\n+1. Launch Microsoft Entra Connect from the desktop or start menu\\\\n+1. Choose **Add an additional Microsoft Entra Domain**\\\\n \\\\n-Use the following steps to add the new top-level domain using PowerShell\\\\n+:::image type=\\\\\\\"content\\\\\\\" source=\\\\\\\"./media/how-to-connect-install-multiple-domains/add1.png\\\\\\\" alt-text=\\\\\\\"Screenshot of the Additional tasks page with Add an additional Microsoft Entra domain selected.\\\\\\\":::\\\\n \\\\n-1. On a machine that has [Azure AD PowerShell module](/previous-versions/azure/jj151815(v=azure.100)) installed on it run the following PowerShell: `$cred=Get-Credential`.\\\\n-2. Enter the username and password of a Hybrid Identity Administrator for the Microsoft Entra domain you're federating with\\\\n-3. In PowerShell, enter `Connect-Entra -Scopes 'Domain.ReadWrite.All'`\\\\n-4. In PowerShell, enter `New-MgDomainFederationConfiguration –SupportMultipleDomain –DomainName`\\\\n+1. Enter your Microsoft Entra ID and Active Directory credentials\\\\n+1. Select the second domain you wish to configure for federation\\\\n \\\\n-Use the following steps to add the new top-level domain using Microsoft Entra Connect.\\\\n-\\\\n-1. Launch Microsoft Entra Connect from the desktop or start menu\\\\n-2. Choose “Add an additional Microsoft Entra Domain”\\\\n-  ![Screenshot that shows the \\\\\\\"Additional tasks\\\\\\\" page with \\\\\\\"Add an additional Microsoft Entra domain\\\\\\\" selected.](./media/how-to-connect-install-multiple-domains/add1.png)\\\\n-3. Enter your Microsoft Entra ID and Active Directory credentials\\\\n-4. Select the second domain you wish to configure for federation.\\\\n-  ![Add an additional Microsoft Entra domain](./media/how-to-connect-install-multiple-domains/add2.png)\\\\n-5. Click Install\\\\n+:::image type=\\\\\\\"content\\\\\\\" source=\\\\\\\"./media/how-to-connect-install-multiple-domains/add2.png\\\\\\\" alt-text=\\\\\\\"Screenshot of Add an additional Microsoft Entra domain.\\\\\\\":::\\\\n+1. Select **Install**.\\\\n \\\\n ### Verify the new top-level domain\\\\n-By using the PowerShell command `Get-MgDomainFederationConfiguration -DomainName <your domain>`you can view the updated IssuerUri. The screenshot below shows the federation settings were updated on the original domain `http://bmcontoso.com/adfs/services/trust`\\\\n+Use the PowerShell command `Get-MgDomainFederationConfiguration -DomainName <your domain>` to view the updated IssuerUri. The screenshot below shows that the federation settings are updated on the original domain `http://bmcontoso.com/adfs/services/trust`.\\\\n \\\\n \\\\n And the IssuerUri on the new domain has been set to `https://bmcontoso.com/adfs/services/trust`\\\\n \\\\n ## Support for subdomains\\\\n-When you add a subdomain, because of the way Microsoft Entra ID handled domains, it inherits the settings of the parent. So, the IssuerUri, needs to match the parents.\\\\n \\\\n-So lets say, for example, that I have bmcontoso.com and then add corp.bmcontoso.com. The IssuerUri for a user from corp.bmcontoso.com needs to be **`http://bmcontoso.com/adfs/services/trust`**. However the standard rule implemented above for Microsoft Entra ID, generates a token with an issuer as **`http://corp.bmcontoso.com/adfs/services/trust`**, which won't match the domain's required value and authentication fails.\\\\n+When you add a subdomain, because of the way Microsoft Entra ID handles domains, it inherits the settings of the parent. So, the IssuerUri needs to match the parent domain.\\\\n+\\\\n+For example, if you have bmcontoso.com and then add corp.bmcontoso.com, The IssuerUri for a user from corp.bmcontoso.com needs to be **`http://bmcontoso.com/adfs/services/trust`**. However the standard rule implemented above for Microsoft Entra ID, generates a token with an issuer as **`http://corp.bmcontoso.com/adfs/services/trust`**, which won't match the domain's required value and authentication fails.\\\\n \\\\n-### How To enable support for subdomains\\\\n-In order to work around this behavior, the AD FS relying party trust for Microsoft Online needs to be updated. To do this, you must configure a custom claim rule so that it strips off any subdomains from the user’s UPN suffix when constructing the custom Issuer value.\\\\n+### How to enable support for subdomains\\\\n+To work around this behavior, update the AD FS relying party trust for Microsoft Online. To do this, you must configure a custom claim rule so that it strips off any subdomains from the user’s UPN suffix when constructing the custom Issuer value.\\\\n \\\\n Use the following claim:\\\\n \\\\n ```  \\\\n c:[Type == \\\\\\\"http://schemas.xmlsoap.org/claims/UPN\\\\\\\"] => issue(Type = \\\\\\\"http://schemas.microsoft.com/ws/2008/06/identity/claims/issuerid\\\\\\\", Value = regexreplace(c.Value, \\\\\\\"^.*@([^.]+\\\\\\\\.)*?(?<domain>([^.]+\\\\\\\\.?){2})$\\\\\\\", \\\\\\\"http://${domain}/adfs/services/trust/\\\\\\\"));\\\\n ```\\\\n \\\\n-[!NOTE]\\\\n-The last number in the regular expression set is how many parent domains there are in your root domain. Here bmcontoso.com is used, so two parent domains are necessary. If three parent domains were to be kept (that is, corp.bmcontoso.com), then the number would have been three. Eventually a range can be indicated, the match is made to match the maximum of domains. \\\\\\\"{2,3}\\\\\\\" matches two to three domains (that is, bmfabrikam.com and corp.bmcontoso.com).\\\\n+> [!NOTE]\\\\n+> The last number in the regular expression set is how many parent domains there are in your root domain. Here bmcontoso.com is used, so two parent domains are necessary. If three parent domains were to be kept (that is, corp.bmcontoso.com), then the number would have been three. Eventually a range can be indicated, the match is made to match the maximum of domains. \\\\\\\"{2,3}\\\\\\\" matches two to three domains (that is, bmfabrikam.com and corp.bmcontoso.com).\\\\n \\\\n Use the following steps to add a custom claim to support subdomains.\\\\n \\\\n 1. Open AD FS Management\\\\n-2. Right-click the Microsoft Online RP trust and choose Edit Claim rules\\\\n-3. Select the third claim rule, and replace\\\\n-  ![Edit claim](./media/how-to-connect-install-multiple-domains/sub1.png)\\\\n-4. Replace the current claim:\\\\n+1. Right-click the Microsoft Online RP trust and select **Edit Claim Rules**.\\\\n+1. Select the third claim rule, and replace\\\\n+\\\\n+:::image type=\\\\\\\"content\\\\\\\" source=\\\\\\\"./media/how-to-connect-install-multiple-domains/sub1.png\\\\\\\" alt-text=\\\\\\\"Screenshot of the Edit claim dialog.\\\\\\\":::\\\\n+1. Replace the current claim:\\\\n \\\\n   ```\\\\n   c:[Type == \\\\\\\"http://schemas.xmlsoap.org/claims/UPN\\\\\\\"] => issue(Type = \\\\\\\"http://schemas.microsoft.com/ws/2008/06/identity/claims/issuerid\\\\\\\", Value = regexreplace(c.Value, \\\\\\\".+@(?<domain>.+)\\\\\\\",\\\\\\\"http://${domain}/adfs/services/trust/\\\\\\\"));\\\\n@@ -136,15 +132,15 @@ Use the following steps to add a custom claim to support subdomains.\\\\n   c:[Type == \\\\\\\"http://schemas.xmlsoap.org/claims/UPN\\\\\\\"] => issue(Type = \\\\\\\"http://schemas.microsoft.com/ws/2008/06/identity/claims/issuerid\\\\\\\", Value = regexreplace(c.Value, \\\\\\\"^.*@([^.]+\\\\\\\\.)*?(?<domain>([^.]+\\\\\\\\.?){2})$\\\\\\\", \\\\\\\"http://${domain}/adfs/services/trust/\\\\\\\"));\\\\n   ```\\\\n \\\\n-  ![Replace claim](./media/how-to-connect-install-multiple-domains/sub2.png)\\\\n+  :::image type=\\\\\\\"content\\\\\\\" source=\\\\\\\"./media/how-to-connect-install-multiple-domains/sub2.png\\\\\\\" alt-text=\\\\\\\"Screenshot of the Replace claim dialog.\\\\\\\":::\\\\n \\\\n-5. Click Ok. Click Apply. Click Ok. Close AD FS Management.\\\\n+1. Select **OK**, then select **Apply**, and finally select **OK** again. Close AD FS Management.\\\\n \\\\n ## Next steps\\\\n-Now that you have Microsoft Entra Connect installed you can [verify the installation and assign licenses](how-to-connect-post-installation.md).\\\\n+Now that you have Microsoft Entra Connect installed, you can [verify the installation and assign licenses](how-to-connect-post-installation.md).\\\\n \\\\n-Learn more about these features, which were enabled with the installation: [Automatic upgrade](how-to-connect-install-automatic-upgrade.md), [Prevent accidental deletes](how-to-connect-sync-feature-prevent-accidental-deletes.md), and [Microsoft Entra Connect Health](how-to-connect-health-sync.md).\\\\n+Learn more about these features enabled during installation: [Automatic upgrade](how-to-connect-install-automatic-upgrade.md), [Prevent accidental deletes](how-to-connect-sync-feature-prevent-accidental-deletes.md), and [Microsoft Entra Connect Health](how-to-connect-health-sync.md).\\\\n \\\\n-Learn more about these common topics: [scheduler and how to trigger sync](how-to-connect-sync-feature-scheduler.md).\\\\n+Explore these common topics: [scheduler and how to trigger sync](how-to-connect-sync-feature-scheduler.md).\\\\n \\\\n-Learn more about [Integrating your on-premises identities with Microsoft Entra ID](../whatis-hybrid-identity.md).\\\\n+Read about [integrating your on-premises identities with Microsoft Entra ID](../whatis-hybrid-identity.md).\\\\n\\\\\\\\ No newline at end of file\\\"\\r\\n  },\\r\\n  {\\r\\n    \\\"sha\\\": \\\"42a92e2c514ed29e0ffe5017d8107a67d0ed1971\\\",\\r\\n    \\\"filename\\\": \\\"docs/identity/hybrid/connect/media/how-to-connect-install-multiple-domains/entra-fed-property.png\\\",\\r\\n    \\\"status\\\": \\\"added\\\",\\r\\n    \\\"additions\\\": 0,\\r\\n    \\\"deletions\\\": 0,\\r\\n    \\\"changes\\\": 0,\\r\\n    \\\"blob_url\\\": \\\"https://github.com/MicrosoftDocs/entra-docs/blob/9b4b4ce9d857c07128199d50bb729dc7e3a6621e/docs%2Fidentity%2Fhybrid%2Fconnect%2Fmedia%2Fhow-to-connect-install-multiple-domains%2Fentra-fed-property.png\\\",\\r\\n    \\\"raw_url\\\": \\\"https://github.com/MicrosoftDocs/entra-docs/raw/9b4b4ce9d857c07128199d50bb729dc7e3a6621e/docs%2Fidentity%2Fhybrid%2Fconnect%2Fmedia%2Fhow-to-connect-install-multiple-domains%2Fentra-fed-property.png\\\",\\r\\n    \\\"contents_url\\\": \\\"https://api.github.com/repos/MicrosoftDocs/entra-docs/contents/docs%2Fidentity%2Fhybrid%2Fconnect%2Fmedia%2Fhow-to-connect-install-multiple-domains%2Fentra-fed-property.png?ref=9b4b4ce9d857c07128199d50bb729dc7e3a6621e\\\"\\r\\n  }\\r\\n]. Please summarise it in a few sentences, using UK grammar and ensure the response is formatted for markdown. Do not start the response with here is summary.\"}",
    "Response": "Here's a summary of the changes:\n\nThese commits update three documentation pages related to Microsoft Entra Connect and federation with Microsoft Entra ID. The primary focus is on clarifying the process for managing multiple top-level domains and subdomains when federating, especially in light of the `SupportMultipleDomain` parameter being deprecated in newer PowerShell modules. The documentation has been revised to reflect the current PowerShell cmdlets and best practices for updating federation configurations and managing certificates. Additionally, an image has been added to illustrate the output of the `Get-EntraFederationProperty` cmdlet.",
    "Model": "google:gemini-2.5-flash-lite",
    "Provider": "google",
    "ModelName": "gemini-2.5-flash-lite",
    "Timestamp": "2025-09-18T23:01:24.9040294+00:00"
  },
  "files": [
    {
      "filename": "docs/identity/hybrid/connect/how-to-connect-emergency-ad-fs-certificate-rotation.md",
      "status": "modified",
      "additions": 27,
      "deletions": 20
    },
    {
      "filename": "docs/identity/hybrid/connect/how-to-connect-fed-o365-certs.md",
      "status": "modified",
      "additions": 24,
      "deletions": 11
    },
    {
      "filename": "docs/identity/hybrid/connect/how-to-connect-install-multiple-domains.md",
      "status": "modified",
      "additions": 65,
      "deletions": 69
    },
    {
      "filename": "docs/identity/hybrid/connect/media/how-to-connect-install-multiple-domains/entra-fed-property.png",
      "status": "added",
      "additions": 0,
      "deletions": 0
    }
  ]
}